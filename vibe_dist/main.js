(()=>{"use strict";var t={197:t=>{t.exports=require("obsidian")},927:function(t,e,n){var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(s,a){function o(t){try{r(i.next(t))}catch(t){a(t)}}function l(t){try{r(i.throw(t))}catch(t){a(t)}}function r(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,l)}r((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=n(197),a={defaultLimit:60,autosaveInterval:10,minIslandWidth:100};class o extends s.Plugin{constructor(){super(...arguments),this.runtime={},this.timers=new Map,this.flushHandle=null}onload(){return i(this,void 0,void 0,function*(){yield this.loadDataFile(),this.addSettingTab(new l(this.app,this)),this.registerMarkdownPostProcessor((t,e)=>{t.querySelectorAll("code").forEach(t=>{var n;const a=null!==(n=t.textContent)&&void 0!==n?n:"";if(!a.trim().startsWith("stopwatch"))return;const o=function(t,e){var n;const i={},s=/(id|name|passed|limit|running):\s*([^\s]+)/g;for(let e;e=s.exec(t);)i[e[1]]=e[2];return{spec:{id:null!==(n=i.id)&&void 0!==n?n:"",passed:i.passed?d(i.passed):0,limit:i.limit?d(i.limit):e,name:i.name,running:"yes"===i.running},hasId:!!i.id}}(a,this.settings.defaultLimit),l=this.runtime[o.spec.id];l&&(o.spec.passed=l.passed,o.spec.running=l.running),o.hasId||function(t,e,n,a){i(this,void 0,void 0,function*(){const i=t.app.vault.getAbstractFileByPath(e.sourcePath);if(!(i instanceof s.TFile))return;let o=yield t.app.vault.read(i);const l=function(t){for(;;){const e=Math.random().toString(36).slice(2,8);if(!t.includes(`id:${e}`))return e}}(o),r=n.replace(/^stopwatch/,`stopwatch id:${l} running:no`);o=o.replace("`"+n+"`","`"+r+"`"),yield t.app.vault.modify(i,o),a.id=l,a.running=!1})}(this,e,a,o.spec),t.replaceWith(function(t,e,n,s){const a=document.createElement("span");a.addClass("inline-stopwatch-wrapper");const{button:o,setIcon:l}=function(){const t=document.createElement("button");t.addClass("inline-stopwatch-button");const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttr("viewBox","0 0 16 16");const n=document.createElementNS("http://www.w3.org/2000/svg","path");e.appendChild(n),t.appendChild(e);const i=t=>n.setAttr("d",t?"M2 2h4v12H2zm8 0h4v12h-4z":"M3 2v12l10-6-10-6z");return i(!1),{button:t,setIcon:i}}(),{island:r,timeSpan:d,fill:u}=function(t,e){const n=document.createElement("span");if(n.addClass("inline-stopwatch-island"),n.style.minWidth=`${e}px`,t.name){const e=document.createElement("span");e.addClass("inline-stopwatch-name"),e.textContent=t.name,n.appendChild(e)}const i=document.createElement("span");i.addClass("inline-stopwatch-time"),t.name&&i.addClass("inline-stopwatch-muted"),n.appendChild(i);const s=document.createElement("div");s.addClass("inline-stopwatch-timeline");const a=document.createElement("div");return a.addClass("inline-stopwatch-fill"),s.appendChild(a),n.appendChild(s),{island:n,timeSpan:i,fill:a}}(t,s);a.appendChild(o),a.appendChild(r);const h=e=>{d.textContent=c(e);const n=e%t.limit/t.limit;Math.floor(e/t.limit)%2==1?(u.style.right="0",u.style.left="auto",u.style.width=`${(100*(1-n)).toFixed(2)}%`):(u.style.left="0",u.style.right="auto",u.style.width=`${(100*n).toFixed(2)}%`)};h(t.passed);let p=t.running,v=t.passed,m=0,f=null;e.runtime[t.id]={passed:v,running:p};const g={id:t.id,filePath:n.sourcePath,currentPassed:()=>Math.floor(p?v+(Date.now()-m)/1e3:v),isRunning:()=>p,confirmSaved:(n,i)=>{v=n,p=i,i&&(m=Date.now()),e.runtime[t.id]={passed:n,running:i}}};e.registerTimer(g);const w=()=>i(this,void 0,void 0,function*(){p=!0,l(!0),m=Date.now(),f=window.setInterval(()=>h(g.currentPassed()),100),g.confirmSaved(v,!0),yield e.saveDataFile()}),y=()=>i(this,void 0,void 0,function*(){const t=Math.floor(v+(Date.now()-m)/1e3);f&&window.clearInterval(f),p=!1,l(!1),v=t,g.confirmSaved(v,!1),h(v),yield e.persistAllTimers(),yield e.saveDataFile()});return o.onclick=()=>p?y():w(),p&&w(),a}(o.spec,this,e,this.settings.minIslandWidth))})}),this.startAutosaveInterval()})}onunload(){this.stopAutosaveInterval(),this.flushRuntime()}loadDataFile(){return i(this,void 0,void 0,function*(){var t,e;const n=null!==(t=yield this.loadData())&&void 0!==t?t:{};this.settings=Object.assign({},a,n.settings),this.runtime=null!==(e=n.runtime)&&void 0!==e?e:{}})}saveDataFile(){return i(this,void 0,void 0,function*(){const t={settings:this.settings,runtime:this.runtime};yield this.saveData(t)})}startAutosaveInterval(){this.flushHandle=window.setInterval(()=>this.flushRuntime(),1e3*this.settings.autosaveInterval)}stopAutosaveInterval(){this.flushHandle&&window.clearInterval(this.flushHandle),this.flushHandle=null}setAutosaveInterval(t){return i(this,void 0,void 0,function*(){this.settings.autosaveInterval=t,yield this.saveDataFile(),this.stopAutosaveInterval(),this.startAutosaveInterval()})}registerTimer(t){this.timers.set(t.id,t)}unregisterTimer(t){this.timers.delete(t)}flushRuntime(){return i(this,void 0,void 0,function*(){for(const t of this.timers.values())this.runtime[t.id]={passed:t.currentPassed(),running:t.isRunning()};yield this.saveDataFile()})}persistAllTimers(){return i(this,void 0,void 0,function*(){var t;const e=new Map;for(const t of this.timers.values())e.has(t.filePath)||e.set(t.filePath,[]),e.get(t.filePath).push(t);for(const[n,i]of e){const e=this.app.vault.getAbstractFileByPath(n);if(!(e instanceof s.TFile))continue;let a=yield this.app.vault.read(e);const o=a;for(const e of i){const n=null!==(t=this.runtime[e.id])&&void 0!==t?t:{passed:e.currentPassed(),running:e.isRunning()},i=n.passed,s=n.running?"yes":"no",o=new RegExp("`[^`]*\\bid:"+r(e.id)+"\\b[^`]*`","g");a=a.replace(o,t=>{let e=t.replace(/passed:\s*\d+/,`passed:${i}`);return e=e.match(/running:/)?e.replace(/running:\s*(yes|no)/,`running:${s}`):e.replace(/limit:[^`]+/,t=>`${t} running:${s}`),e})}a!==o&&(yield this.app.vault.adapter.write(n,a))}})}}e.default=o;class l extends s.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){const t=this.containerEl;t.empty(),new s.Setting(t).setName("Default limit (seconds)").addText(t=>t.setValue(String(this.plugin.settings.defaultLimit)).onChange(t=>i(this,void 0,void 0,function*(){const e=+t;e>0&&(this.plugin.settings.defaultLimit=e,yield this.plugin.saveDataFile())}))),new s.Setting(t).setName("Autosave interval (seconds)").addText(t=>t.setValue(String(this.plugin.settings.autosaveInterval)).onChange(t=>i(this,void 0,void 0,function*(){const e=+t;e>0&&(yield this.plugin.setAutosaveInterval(e))}))),new s.Setting(t).setName("Minimum island width (px)").addText(t=>t.setValue(String(this.plugin.settings.minIslandWidth)).onChange(t=>i(this,void 0,void 0,function*(){const e=+t;e>0&&(this.plugin.settings.minIslandWidth=e,yield this.plugin.saveDataFile())})))}}const r=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function d(t){const e=t.split(":").map(t=>+t);for(;e.length<3;)e.unshift(0);return 3600*e[0]+60*e[1]+e[2]}const u=t=>t.toString().padStart(2,"0"),c=t=>`${u(t/3600|0)}:${u(t%3600/60|0)}:${u(t%60)}`}},e={},n=function n(i){var s=e[i];if(void 0!==s)return s.exports;var a=e[i]={exports:{}};return t[i].call(a.exports,a,a.exports,n),a.exports}(927);module.exports=n})();