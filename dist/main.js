"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const obsidian_1 = require("obsidian");
class InlineStopwatchPlugin extends obsidian_1.Plugin {
    onload() {
        this.registerMarkdownPostProcessor((el, ctx) => {
            const codes = el.querySelectorAll('code');
            codes.forEach(code => {
                var _a;
                const text = (_a = code.textContent) === null || _a === void 0 ? void 0 : _a.trim();
                if (!text || !text.startsWith('stopwatch'))
                    return;
                const parsed = parseSpec(text);
                const comp = createStopwatch(parsed.spec, this, ctx, text, parsed.hasPassed);
                code.replaceWith(comp);
            });
        });
    }
}
exports.default = InlineStopwatchPlugin;
function parseSpec(text) {
    const record = {};
    const regex = /(name|passed|limit):\s*([^\s]+)/g;
    let match;
    while ((match = regex.exec(text)) !== null) {
        record[match[1]] = match[2];
    }
    const hasPassed = record['passed'] !== undefined;
    const passed = record['passed'] ? parseTime(record['passed']) : 0;
    const limit = record['limit'] ? parseTime(record['limit']) : undefined;
    const name = record['name'];
    return { spec: { passed, limit, name }, hasPassed };
}
function parseTime(str) {
    const parts = str.split(':').map((p) => parseInt(p, 10));
    while (parts.length < 3)
        parts.unshift(0);
    const [h, m, s] = parts;
    return h * 3600 + m * 60 + s;
}
function formatTime(sec) {
    const h = Math.floor(sec / 3600).toString().padStart(2, '0');
    const m = Math.floor((sec % 3600) / 60).toString().padStart(2, '0');
    const s = Math.floor(sec % 60).toString().padStart(2, '0');
    return `${h}:${m}:${s}`;
}
function buildSpecString(original, passed) {
    const record = {};
    const regex = /(name|passed|limit):\s*([^\s]+)/g;
    let match;
    while ((match = regex.exec(original)) !== null) {
        record[match[1]] = match[2];
    }
    record['passed'] = formatTime(passed);
    let result = 'stopwatch';
    if (record['name'])
        result += ` name: ${record['name']}`;
    result += ` passed: ${record['passed']}`;
    if (record['limit'])
        result += ` limit: ${record['limit']}`;
    return result;
}
function createStopwatch(spec, plugin, ctx, original, hasPassed) {
    const container = document.createElement('span');
    container.addClass('inline-stopwatch');
    const button = document.createElement('button');
    button.addClass('inline-stopwatch-button');
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttr('viewBox', '0 0 16 16');
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    svg.appendChild(path);
    button.appendChild(svg);
    const setIcon = (playing) => {
        path.setAttr('d', playing
            ? 'M2 2h4v12H2zm8 0h4v12h-4z' /* pause */
            : 'M3 2v12l10-6-10-6z' /* play */);
    };
    setIcon(false);
    const nameSpan = document.createElement('span');
    if (spec.name) {
        nameSpan.addClass('inline-stopwatch-name');
        nameSpan.textContent = ` ${spec.name} `;
    }
    const timeSpan = document.createElement('span');
    timeSpan.addClass('inline-stopwatch-time');
    timeSpan.textContent = formatTime(spec.passed);
    const timeline = document.createElement('div');
    let fill = null;
    if (spec.limit !== undefined) {
        timeline.addClass('inline-stopwatch-timeline');
        fill = document.createElement('div');
        fill.addClass('inline-stopwatch-fill');
        timeline.appendChild(fill);
    }
    container.appendChild(button);
    if (spec.name)
        container.appendChild(nameSpan);
    container.appendChild(timeSpan);
    if (spec.limit !== undefined)
        container.appendChild(timeline);
    let running = false;
    let start = 0;
    let interval = null;
    let currentText = original;
    let currentPassed = spec.passed;
    const tick = () => {
        const now = Date.now();
        const elapsed = currentPassed + Math.floor((now - start) / 1000);
        timeSpan.textContent = formatTime(elapsed);
        if (fill && spec.limit) {
            const cycle = elapsed % (spec.limit * 2);
            let progress = 0;
            if (cycle < spec.limit) {
                progress = cycle / spec.limit;
            }
            else {
                progress = 1 - (cycle - spec.limit) / spec.limit;
            }
            fill.style.width = `${Math.max(0, Math.min(1, progress)) * 100}%`;
        }
    };
    const updatePassedInFile = (seconds) => __awaiter(this, void 0, void 0, function* () {
        const file = plugin.app.vault.getAbstractFileByPath(ctx.sourcePath);
        if (!(file instanceof obsidian_1.TFile))
            return;
        let content = yield plugin.app.vault.read(file);
        const newSnippet = buildSpecString(currentText, seconds);
        content = content.replace(`\`${currentText}\``, `\`${newSnippet}\``);
        yield plugin.app.vault.modify(file, content);
        currentText = newSnippet;
    });
    button.onclick = () => __awaiter(this, void 0, void 0, function* () {
        if (!running) {
            running = true;
            setIcon(true);
            start = Date.now();
            interval = window.setInterval(tick, 500);
            if (!hasPassed) {
                yield updatePassedInFile(currentPassed);
                hasPassed = true;
            }
        }
        else {
            running = false;
            setIcon(false);
            if (interval)
                window.clearInterval(interval);
            const diff = Math.floor((Date.now() - start) / 1000);
            currentPassed += diff;
            yield updatePassedInFile(currentPassed);
        }
    });
    return container;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsdUNBQXVFO0FBY3ZFLE1BQXFCLHFCQUFzQixTQUFRLGlCQUFNO0lBQ3JELE1BQU07UUFDRixJQUFJLENBQUMsNkJBQTZCLENBQUMsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFFM0MsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7O2dCQUNqQixNQUFNLElBQUksR0FBRyxNQUFBLElBQUksQ0FBQyxXQUFXLDBDQUFFLElBQUksRUFBRSxDQUFDO2dCQUN0QyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUM7b0JBQUUsT0FBTztnQkFDbkQsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUMvQixNQUFNLElBQUksR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBRTdFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0IsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQWZELHdDQWVDO0FBRUQsU0FBUyxTQUFTLENBQUMsSUFBWTtJQUUzQixNQUFNLE1BQU0sR0FBMkIsRUFBRSxDQUFDO0lBQzFDLE1BQU0sS0FBSyxHQUFHLGtDQUFrQyxDQUFDO0lBQ2pELElBQUksS0FBNkIsQ0FBQztJQUNsQyxPQUFPLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxJQUFJ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RyxLQUFLLENBQUM7WUFDaEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2YsSUFBSSxRQUFRO2dCQUFFLE1BQU0sQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDN0MsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztZQUNyRCxhQUFhLElBQUksSUFBSSxDQUFDO1lBQ3RCLE1BQU0sa0JBQWtCLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFNUMsQ0FBQztJQUNMLENBQUMsQ0FBQSxDQUFDO0lBRUYsT0FBTyxTQUFTLENBQUM7QUFDckIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBsdWdpbiwgTWFya2Rvd25Qb3N0UHJvY2Vzc29yQ29udGV4dCwgVEZpbGUgfSBmcm9tICdvYnNpZGlhbic7XHJcblxyXG5cclxuaW50ZXJmYWNlIFN0b3B3YXRjaFNldHRpbmdzIHtcclxuICAgIHBhc3NlZDogbnVtYmVyOyAvLyBzZWNvbmRzXHJcbiAgICBsaW1pdD86IG51bWJlcjsgLy8gc2Vjb25kc1xyXG4gICAgbmFtZT86IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIFBhcnNlZFNwZWMge1xyXG4gICAgc3BlYzogU3RvcHdhdGNoU2V0dGluZ3M7XHJcbiAgICBoYXNQYXNzZWQ6IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIElubGluZVN0b3B3YXRjaFBsdWdpbiBleHRlbmRzIFBsdWdpbiB7XHJcbiAgICBvbmxvYWQoKSB7XHJcbiAgICAgICAgdGhpcy5yZWdpc3Rlck1hcmtkb3duUG9zdFByb2Nlc3NvcigoZWwsIGN0eCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY29kZXMgPSBlbC5xdWVyeVNlbGVjdG9yQWxsKCdjb2RlJyk7XHJcbiAgICAgICAgICAgIGNvZGVzLmZvckVhY2goY29kZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gY29kZS50ZXh0Q29udGVudD8udHJpbSgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0ZXh0IHx8ICF0ZXh0LnN0YXJ0c1dpdGgoJ3N0b3B3YXRjaCcpKSByZXR1cm47XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBwYXJzZVNwZWModGV4dCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb21wID0gY3JlYXRlU3RvcHdhdGNoKHBhcnNlZC5zcGVjLCB0aGlzLCBjdHgsIHRleHQsIHBhcnNlZC5oYXNQYXNzZWQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvZGUucmVwbGFjZVdpdGgoY29tcCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZVNwZWModGV4dDogc3RyaW5nKTogUGFyc2VkU3BlYyB7XHJcblxyXG4gICAgY29uc3QgcmVjb3JkOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XHJcbiAgICBjb25zdCByZWdleCA9IC8obmFtZXxwYXNzZWR8bGltaXQpOlxccyooW15cXHNdKykvZztcclxuICAgIGxldCBtYXRjaDogUmVnRXhwRXhlY0FycmF5IHwgbnVsbDtcclxuICAgIHdoaWxlICgobWF0Y2ggPSByZWdleC5leGVjKHRleHQpKSAhPT0gbnVsbCkge1xyXG4gICAgICAgIHJlY29yZFttYXRjaFsxXV0gPSBtYXRjaFsyXTtcclxuICAgIH1cclxuICAgIGNvbnN0IGhhc1Bhc3NlZCA9IHJlY29yZFsncGFzc2VkJ10gIT09IHVuZGVmaW5lZDtcclxuICAgIGNvbnN0IHBhc3NlZCA9IHJlY29yZFsncGFzc2VkJ10gPyBwYXJzZVRpbWUocmVjb3JkWydwYXNzZWQnXSkgOiAwO1xyXG4gICAgY29uc3QgbGltaXQgPSByZWNvcmRbJ2xpbWl0J10gPyBwYXJzZVRpbWUocmVjb3JkWydsaW1pdCddKSA6IHVuZGVmaW5lZDtcclxuICAgIGNvbnN0IG5hbWUgPSByZWNvcmRbJ25hbWUnXTtcclxuICAgIHJldHVybiB7IHNwZWM6IHsgcGFzc2VkLCBsaW1pdCwgbmFtZSB9LCBoYXNQYXNzZWQgfTtcclxuXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlVGltZShzdHI6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICBjb25zdCBwYXJ0cyA9IHN0ci5zcGxpdCgnOicpLm1hcCgocCkgPT4gcGFyc2VJbnQocCwgMTApKTtcclxuICAgIHdoaWxlIChwYXJ0cy5sZW5ndGggPCAzKSBwYXJ0cy51bnNoaWZ0KDApO1xyXG4gICAgY29uc3QgW2gsIG0sIHNdID0gcGFydHM7XHJcbiAgICByZXR1cm4gaCAqIDM2MDAgKyBtICogNjAgKyBzO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmb3JtYXRUaW1lKHNlYzogbnVtYmVyKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGggPSBNYXRoLmZsb29yKHNlYyAvIDM2MDApLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKTtcclxuICAgIGNvbnN0IG0gPSBNYXRoLmZsb29yKChzZWMgJSAzNjAwKSAvIDYwKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyk7XHJcbiAgICBjb25zdCBzID0gTWF0aC5mbG9vcihzZWMgJSA2MCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpO1xyXG4gICAgcmV0dXJuIGAke2h9OiR7bX06JHtzfWA7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGJ1aWxkU3BlY1N0cmluZyhvcmlnaW5hbDogc3RyaW5nLCBwYXNzZWQ6IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICBjb25zdCByZWNvcmQ6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcclxuICAgIGNvbnN0IHJlZ2V4ID0gLyhuYW1lfHBhc3NlZHxsaW1pdCk6XFxzKihbXlxcc10rKS9nO1xyXG4gICAgbGV0IG1hdGNoOiBSZWdFeHBFeGVjQXJyYXkgfCBudWxsO1xyXG4gICAgd2hpbGUgKChtYXRjaCA9IHJlZ2V4LmV4ZWMob3JpZ2luYWwpKSAhPT0gbnVsbCkge1xyXG4gICAgICAgIHJlY29yZFttYXRjaFsxXV0gPSBtYXRjaFsyXTtcclxuICAgIH1cclxuICAgIHJlY29yZFsncGFzc2VkJ10gPSBmb3JtYXRUaW1lKHBhc3NlZCk7XHJcbiAgICBsZXQgcmVzdWx0ID0gJ3N0b3B3YXRjaCc7XHJcbiAgICBpZiAocmVjb3JkWyduYW1lJ10pIHJlc3VsdCArPSBgIG5hbWU6ICR7cmVjb3JkWyduYW1lJ119YDtcclxuICAgIHJlc3VsdCArPSBgIHBhc3NlZDogJHtyZWNvcmRbJ3Bhc3NlZCddfWA7XHJcbiAgICBpZiAocmVjb3JkWydsaW1pdCddKSByZXN1bHQgKz0gYCBsaW1pdDogJHtyZWNvcmRbJ2xpbWl0J119YDtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZVN0b3B3YXRjaChcclxuICAgIHNwZWM6IFN0b3B3YXRjaFNldHRpbmdzLFxyXG4gICAgcGx1Z2luOiBJbmxpbmVTdG9wd2F0Y2hQbHVnaW4sXHJcbiAgICBjdHg6IE1hcmtkb3duUG9zdFByb2Nlc3NvckNvbnRleHQsXHJcbiAgICBvcmlnaW5hbDogc3RyaW5nLFxyXG4gICAgaGFzUGFzc2VkOiBib29sZWFuXHJcbik6IEhUTUxFbGVtZW50IHtcclxuXHJcbiAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XHJcbiAgICBjb250YWluZXIuYWRkQ2xhc3MoJ2lubGluZS1zdG9wd2F0Y2gnKTtcclxuXHJcbiAgICBjb25zdCBidXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKTtcclxuICAgIGJ1dHRvbi5hZGRDbGFzcygnaW5saW5lLXN0b3B3YXRjaC1idXR0b24nKTtcclxuICAgIGNvbnN0IHN2ZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUygnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLCAnc3ZnJyk7XHJcbiAgICBzdmcuc2V0QXR0cigndmlld0JveCcsICcwIDAgMTYgMTYnKTtcclxuICAgIGNvbnN0IHBhdGggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJywgJ3BhdGgnKTtcclxuICAgIHN2Zy5hcHBlbmRDaGlsZChwYXRoKTtcclxuICAgIGJ1dHRvbi5hcHBlbmRDaGlsZChzdmcpO1xyXG4gICAgY29uc3Qgc2V0SWNvbiA9IChwbGF5aW5nOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgcGF0aC5zZXRBdHRyKFxyXG4gICAgICAgICAgICAnZCcsXHJcbiAgICAgICAgICAgIHBsYXlpbmdcclxuICAgICAgICAgICAgICAgID8gJ00yIDJoNHYxMkgyem04IDBoNHYxMmgtNHonIC8qIHBhdXNlICovXHJcbiAgICAgICAgICAgICAgICA6ICdNMyAydjEybDEwLTYtMTAtNnonIC8qIHBsYXkgKi9cclxuICAgICAgICApO1xyXG4gICAgfTtcclxuICAgIHNldEljb24oZmFsc2UpO1xyXG5cclxuXHJcbiAgICBjb25zdCBuYW1lU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuICAgIGlmIChzcGVjLm5hbWUpIHtcclxuICAgICAgICBuYW1lU3Bhbi5hZGRDbGFzcygnaW5saW5lLXN0b3B3YXRjaC1uYW1lJyk7XHJcbiAgICAgICAgbmFtZVNwYW4udGV4dENvbnRlbnQgPSBgICR7c3BlYy5uYW1lfSBgO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRpbWVTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgdGltZVNwYW4uYWRkQ2xhc3MoJ2lubGluZS1zdG9wd2F0Y2gtdGltZScpO1xyXG4gICAgdGltZVNwYW4udGV4dENvbnRlbnQgPSBmb3JtYXRUaW1lKHNwZWMucGFzc2VkKTtcclxuXHJcbiAgICBjb25zdCB0aW1lbGluZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgbGV0IGZpbGw6IEhUTUxEaXZFbGVtZW50IHwgbnVsbCA9IG51bGw7XHJcbiAgICBpZiAoc3BlYy5saW1pdCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgdGltZWxpbmUuYWRkQ2xhc3MoJ2lubGluZS1zdG9wd2F0Y2gtdGltZWxpbmUnKTtcclxuICAgICAgICBmaWxsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgZmlsbC5hZGRDbGFzcygnaW5saW5lLXN0b3B3YXRjaC1maWxsJyk7XHJcbiAgICAgICAgdGltZWxpbmUuYXBwZW5kQ2hpbGQoZmlsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGJ1dHRvbik7XHJcbiAgICBpZiAoc3BlYy5uYW1lKSBjb250YWluZXIuYXBwZW5kQ2hpbGQobmFtZVNwYW4pO1xyXG4gICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHRpbWVTcGFuKTtcclxuICAgIGlmIChzcGVjLmxpbWl0ICE9PSB1bmRlZmluZWQpIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aW1lbGluZSk7XHJcblxyXG4gICAgbGV0IHJ1bm5pbmcgPSBmYWxzZTtcclxuICAgIGxldCBzdGFydCA9IDA7XHJcbiAgICBsZXQgaW50ZXJ2YWw6IG51bWJlciB8IG51bGwgPSBudWxsO1xyXG4gICAgbGV0IGN1cnJlbnRUZXh0ID0gb3JpZ2luYWw7XHJcbiAgICBsZXQgY3VycmVudFBhc3NlZCA9IHNwZWMucGFzc2VkO1xyXG5cclxuICAgIGNvbnN0IHRpY2sgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICBjb25zdCBlbGFwc2VkID0gY3VycmVudFBhc3NlZCArIE1hdGguZmxvb3IoKG5vdyAtIHN0YXJ0KSAvIDEwMDApO1xyXG4gICAgICAgIHRpbWVTcGFuLnRleHRDb250ZW50ID0gZm9ybWF0VGltZShlbGFwc2VkKTtcclxuICAgICAgICBpZiAoZmlsbCAmJiBzcGVjLmxpbWl0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGN5Y2xlID0gZWxhcHNlZCAlIChzcGVjLmxpbWl0ICogMik7XHJcblxyXG4gICAgICAgICAgICBsZXQgcHJvZ3Jlc3MgPSAwO1xyXG4gICAgICAgICAgICBpZiAoY3ljbGUgPCBzcGVjLmxpbWl0KSB7XHJcbiAgICAgICAgICAgICAgICBwcm9ncmVzcyA9IGN5Y2xlIC8gc3BlYy5saW1pdDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHByb2dyZXNzID0gMSAtIChjeWNsZSAtIHNwZWMubGltaXQpIC8gc3BlYy5saW1pdDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmaWxsLnN0eWxlLndpZHRoID0gYCR7TWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgcHJvZ3Jlc3MpKSAqIDEwMH0lYDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHVwZGF0ZVBhc3NlZEluRmlsZSA9IGFzeW5jIChzZWNvbmRzOiBudW1iZXIpID0+IHtcclxuICAgICAgICBjb25zdCBmaWxlID0gcGx1Z2luLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoY3R4LnNvdXJjZVBhdGgpO1xyXG4gICAgICAgIGlmICghKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkpIHJldHVybjtcclxuICAgICAgICBsZXQgY29udGVudCA9IGF3YWl0IHBsdWdpbi5hcHAudmF1bHQucmVhZChmaWxlKTtcclxuICAgICAgICBjb25zdCBuZXdTbmlwcGV0ID0gYnVpbGRTcGVjU3RyaW5nKGN1cnJlbnRUZXh0LCBzZWNvbmRzKTtcclxuICAgICAgICBjb250ZW50ID0gY29udGVudC5yZXBsYWNlKGBcXGAke2N1cnJlbnRUZXh0fVxcYGAsIGBcXGAke25ld1NuaXBwZXR9XFxgYCk7XHJcbiAgICAgICAgYXdhaXQgcGx1Z2luLmFwcC52YXVsdC5tb2RpZnkoZmlsZSwgY29udGVudCk7XHJcbiAgICAgICAgY3VycmVudFRleHQgPSBuZXdTbmlwcGV0O1xyXG4gICAgfTtcclxuXHJcbiAgICBidXR0b24ub25jbGljayA9IGFzeW5jICgpID0+IHtcclxuICAgICAgICBpZiAoIXJ1bm5pbmcpIHtcclxuICAgICAgICAgICAgcnVubmluZyA9IHRydWU7XHJcbiAgICAgICAgICAgIHNldEljb24odHJ1ZSk7XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgaW50ZXJ2YWwgPSB3aW5kb3cuc2V0SW50ZXJ2YWwodGljaywgNTAwKTtcclxuICAgICAgICAgICAgaWYgKCFoYXNQYXNzZWQpIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHVwZGF0ZVBhc3NlZEluRmlsZShjdXJyZW50UGFzc2VkKTtcclxuICAgICAgICAgICAgICAgIGhhc1Bhc3NlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBydW5uaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHNldEljb24oZmFsc2UpO1xyXG4gICAgICAgICAgICBpZiAoaW50ZXJ2YWwpIHdpbmRvdy5jbGVhckludGVydmFsKGludGVydmFsKTtcclxuICAgICAgICAgICAgY29uc3QgZGlmZiA9IE1hdGguZmxvb3IoKERhdGUubm93KCkgLSBzdGFydCkgLyAxMDAwKTtcclxuICAgICAgICAgICAgY3VycmVudFBhc3NlZCArPSBkaWZmO1xyXG4gICAgICAgICAgICBhd2FpdCB1cGRhdGVQYXNzZWRJbkZpbGUoY3VycmVudFBhc3NlZCk7XHJcblxyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIGNvbnRhaW5lcjtcclxufVxyXG4iXX0=